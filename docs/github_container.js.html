<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>github/container.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Actions_Actions.html">Actions</a></li><li><a href="BillingManager.html">BillingManager</a><ul class='methods'><li data-type='method'><a href="BillingManager.html#getActionsBillings">getActionsBillings</a></li><li data-type='method'><a href="BillingManager.html#getAllBillings">getAllBillings</a></li><li data-type='method'><a href="BillingManager.html#getPackagesBillings">getPackagesBillings</a></li><li data-type='method'><a href="BillingManager.html#getStorageBillings">getStorageBillings</a></li></ul></li><li><a href="BranchManager.html">BranchManager</a><ul class='methods'><li data-type='method'><a href="BranchManager.html#createBranchFromMain">createBranchFromMain</a></li><li data-type='method'><a href="BranchManager.html#mergeBranchToMain">mergeBranchToMain</a></li></ul></li><li><a href="CacheManager.html">CacheManager</a><ul class='methods'><li data-type='method'><a href="CacheManager.html#clear">clear</a></li><li data-type='method'><a href="CacheManager.html#getOrFetch">getOrFetch</a></li><li data-type='method'><a href="CacheManager.html#invalidate">invalidate</a></li></ul></li><li><a href="ContainerOperations.html">ContainerOperations</a><ul class='methods'><li data-type='method'><a href="ContainerOperations.html#catchContainers">catchContainers</a></li><li data-type='method'><a href="ContainerOperations.html#checkForLock">checkForLock</a></li><li data-type='method'><a href="ContainerOperations.html#lockContainer">lockContainer</a></li><li data-type='method'><a href="ContainerOperations.html#releaseContainers">releaseContainers</a></li><li data-type='method'><a href="ContainerOperations.html#unlockContainer">unlockContainer</a></li></ul></li><li><a href="GitHubFunctions.GitHubFunctions.html">GitHubFunctions</a></li><li><a href="RepositoryManager.html">RepositoryManager</a><ul class='methods'><li data-type='method'><a href="RepositoryManager.html#createOrUpdateFile">createOrUpdateFile</a></li><li data-type='method'><a href="RepositoryManager.html#createRepository">createRepository</a></li><li data-type='method'><a href="RepositoryManager.html#deleteFile">deleteFile</a></li><li data-type='method'><a href="RepositoryManager.html#getActionsBilling">getActionsBilling</a></li><li data-type='method'><a href="RepositoryManager.html#getCollaborators">getCollaborators</a></li><li data-type='method'><a href="RepositoryManager.html#getContent">getContent</a></li><li data-type='method'><a href="RepositoryManager.html#getOrganization">getOrganization</a></li><li data-type='method'><a href="RepositoryManager.html#getStorageBilling">getStorageBilling</a></li><li data-type='method'><a href="RepositoryManager.html#getUser">getUser</a></li></ul></li><li><a href="ResponseFactory.html">ResponseFactory</a><ul class='methods'><li data-type='method'><a href="ResponseFactory.html#.error">error</a></li><li data-type='method'><a href="ResponseFactory.html#.success">success</a></li></ul></li><li><a href="Storage_Storage.html">Storage</a></li><li><a href="Studies_Studies.html">Studies</a></li><li><a href="UserManager.html">UserManager</a><ul class='methods'><li data-type='method'><a href="UserManager.html#addUserToRepository">addUserToRepository</a></li><li data-type='method'><a href="UserManager.html#getAllUsers">getAllUsers</a></li><li data-type='method'><a href="UserManager.html#getCurrentUser">getCurrentUser</a></li><li data-type='method'><a href="UserManager.html#removeUserFromRepository">removeUserFromRepository</a></li></ul></li><li><a href="Users_Users.html">Users</a></li><li><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html">BaseObjects</a><ul class='methods'><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#_createError">_createError</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#_createSuccess">_createSuccess</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#_executeTransaction">_executeTransaction</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#_invalidateCache">_invalidateCache</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#_validateParams">_validateParams</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#batchUpdate">batchUpdate</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#checkForLock">checkForLock</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#checkForUpdates">checkForUpdates</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#getBranchStatus">getBranchStatus</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.BaseObjects.html#search">search</a></li></ul></li><li><a href="module-GitHubAuth-GitHubAuth.html">GitHubAuth</a><ul class='methods'><li data-type='method'><a href="module-GitHubAuth-GitHubAuth.html#checkTokenExpiration">checkTokenExpiration</a></li><li data-type='method'><a href="module-GitHubAuth-GitHubAuth.html#getAccessTokenDeviceFlow">getAccessTokenDeviceFlow</a></li><li data-type='method'><a href="module-GitHubAuth-GitHubAuth.html#getAccessTokenFromConfig">getAccessTokenFromConfig</a></li><li data-type='method'><a href="module-GitHubAuth-GitHubAuth.html#getAuthTypeFromConfig">getAuthTypeFromConfig</a></li><li data-type='method'><a href="module-GitHubAuth-GitHubAuth.html#getFromConfig">getFromConfig</a></li><li data-type='method'><a href="module-GitHubAuth-GitHubAuth.html#verifyAccessToken">verifyAccessToken</a></li><li data-type='method'><a href="module-GitHubAuth-GitHubAuth.html#verifyGitHubSection">verifyGitHubSection</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="api_gitHubServer.module_js.html">api/gitHubServer.js</a></li><li><a href="api_gitHubServer_baseObjects.module_js.html">api/gitHubServer/baseObjects.js</a><ul class='methods'><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~createObj">createObj</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~deleteObj">deleteObj</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~findById">findById</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~findByName">findByName</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~findByX">findByX</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~getAll">getAll</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~linkObj">linkObj</a></li><li data-type='method'><a href="api_gitHubServer_baseObjects.module_js.html#~updateObj">updateObj</a></li></ul></li><li><a href="api_gitHubServer_deprecate.module_js.html">api/gitHubServer_deprecate.js</a><ul class='methods'><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~createObj">createObj</a></li><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~deleteObj">deleteObj</a></li><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~findById">findById</a></li><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~findByName">findByName</a></li><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~findByX">findByX</a></li><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~getAll">getAll</a></li><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~linkObj">linkObj</a></li><li data-type='method'><a href="api_gitHubServer_deprecate.module_js.html#~updateObj">updateObj</a></li></ul></li><li><a href="module-GitHubAuth.html">GitHubAuth</a></li><li><a href="module-GitHubFunctions.html">GitHubFunctions</a><ul class='methods'><li data-type='method'><a href="module-GitHubFunctions.html#~catchContainer">catchContainer</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~checkForLock">checkForLock</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~createBranchFromMain">createBranchFromMain</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~createContainers">createContainers</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~createRepository">createRepository</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~deleteObject">deleteObject</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~getActionsBillings">getActionsBillings</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~getAllUsers">getAllUsers</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~getGitHubOrg">getGitHubOrg</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~getRepoSize">getRepoSize</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~getStorageBillings">getStorageBillings</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~getUser">getUser</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~getWorkflowRuns">getWorkflowRuns</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~lockContainer">lockContainer</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~mergeBranchToMain">mergeBranchToMain</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~readObjects">readObjects</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~releaseContainer">releaseContainer</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~unlockContainer">unlockContainer</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~updateObject">updateObject</a></li><li data-type='method'><a href="module-GitHubFunctions.html#~writeObject">writeObject</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#customEncodeURIComponent">customEncodeURIComponent</a></li><li><a href="global.html#decodeContent">decodeContent</a></li><li><a href="global.html#decodeJsonContent">decodeJsonContent</a></li><li><a href="global.html#encodeContent">encodeContent</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">github/container.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Container operations for GitHub
 * @license Apache-2.0
 * @version 3.0.0
 */

import ResponseFactory from './response.js';
import { encodeContent } from './utils.js';

/**
 * Manages container operations (locking, object manipulation)
 */
class ContainerOperations {
  /**
   * @constructor
   * @param {Object} octokit - Octokit instance
   * @param {String} orgName - GitHub organization name
   * @param {String} repoName - GitHub repository name
   * @param {String} mainBranchName - Main branch name
   * @param {String} lockFileName - Lock file name
   */
  constructor(octokit, orgName, repoName, mainBranchName, lockFileName) {
    this.octokit = octokit;
    this.orgName = orgName;
    this.repoName = repoName;
    this.mainBranchName = mainBranchName;
    this.lockFileName = lockFileName;
  }

  /**
   * Checks if a container is locked
   * @param {String} containerName - Container name
   * @returns {Promise&lt;Array>} ResponseFactory result
   */
  async checkForLock(containerName) {
    try {
      // Get the latest commit
      const latestCommit = await this.octokit.rest.repos.getCommit({
        owner: this.orgName,
        repo: this.repoName,
        ref: this.mainBranchName,
      });

      // Check if the lock file exists
      const mainContents = await this.octokit.rest.repos.getContent({
        owner: this.orgName,
        repo: this.repoName,
        ref: latestCommit.data.sha,
        path: containerName
      });

      const lockExists = mainContents.data.some(
        item => item.path === `${containerName}/${this.lockFileName}`
      );

      if (lockExists) {
        return ResponseFactory.success(
          `Container ${containerName} is locked with lock file ${this.lockFileName}`,
          lockExists,
          200
        );
      } else {
        return ResponseFactory.success(
          `Container ${containerName} is not locked with lock file ${this.lockFileName}`,
          lockExists,
          404
        );
      }
    } catch (err) {
      return ResponseFactory.error(
        `Failed to check if container ${containerName} is locked: ${err.message}`,
        err
      );
    }
  }

  /**
   * Locks a container
   * @param {String} containerName - Container name
   * @returns {Promise&lt;Array>} ResponseFactory result
   */
  async lockContainer(containerName) {
    // Define the full path to the lockfile
    const lockFile = `${containerName}/${this.lockFileName}`;

    try {
      // Get the latest commit
      const { data: latestCommit } = await this.octokit.rest.repos.getCommit({
        owner: this.orgName,
        repo: this.repoName,
        ref: this.mainBranchName,
      });

      const lockResponse = await this.octokit.rest.repos.createOrUpdateFileContents({
        owner: this.orgName,
        repo: this.repoName,
        path: lockFile,
        content: encodeContent(''),
        branch: this.mainBranchName,
        message: `Locking container [${containerName}]`,
        sha: latestCommit.sha
      });

      return ResponseFactory.success(
        `Locked the container ${containerName}`, 
        lockResponse.data
      );
    } catch (err) {
      return ResponseFactory.error(
        `Unable to lock the container ${containerName}: ${err.message}`, 
        err
      );
    }
  }

  /**
   * Unlocks a container
   * @param {String} containerName - Container name
   * @param {String} commitSha - SHA of the lock file
   * @param {String} branchName - Branch name
   * @returns {Promise&lt;Array>} ResponseFactory result
   */
  async unlockContainer(containerName, commitSha, branchName) {
    // Define the full path to the lockfile
    const lockFile = `${containerName}/${this.lockFileName}`;
    
    try {
      const lockExists = await this.checkForLock(containerName);

      if (lockExists[0] &amp;&amp; lockExists[2]) {
        const unlockResponse = await this.octokit.rest.repos.deleteFile({
          owner: this.orgName,
          repo: this.repoName,
          path: lockFile,
          branch: branchName,
          message: `Unlocking container [${containerName}]`,
          sha: commitSha
        });

        return ResponseFactory.success(
          `Unlocked the container ${containerName}`, 
          unlockResponse.data
        );
      } else {
        return ResponseFactory.error(
          `Unable to unlock the container ${containerName}: Lock file not found`, 
          null
        );
      }
    } catch (err) {
      return ResponseFactory.error(
        `Error unlocking container ${containerName}: ${err.message}`, 
        err
      );
    }
  }

  /**
   * Catches multiple containers (locks them and prepares for operations)
   * @param {Object} repoMetadata - Container metadata object
   * @param {Object} objectFiles - Mapping of container names to their object files
   * @param {Function} createBranchFn - Function to create a branch
   * @param {Function} readObjectsFn - Function to read container objects
   * @returns {Promise&lt;Array>} ResponseFactory result
   */
  async catchContainers(repoMetadata, objectFiles, createBranchFn, readObjectsFn) {
    // Check locks
    for (const container in repoMetadata.containers) {
      const lockExists = await this.checkForLock(container);
      if (lockExists[0] &amp;&amp; lockExists[2]) {
        return ResponseFactory.error(
          `The container [${container}] is locked unable and cannot perform creates, updates or deletes on objects.`,
          lockExists,
          503
        );
      }
    }

    // Lock containers
    for (const container in repoMetadata.containers) {
      const locked = await this.lockContainer(container);
      if (!locked[0]) {
        return ResponseFactory.error(
          `Unable to lock [${container}] and cannot perform creates, updates or deletes on objects.`,
          locked,
          503
        );
      }
      repoMetadata.containers[container].lockSha = locked[2].content.sha;
    }

    // Create branch
    const branchCreated = await createBranchFn();
    if (!branchCreated[0]) {
      return ResponseFactory.error(
        'Unable to create new branch',
        branchCreated,
        503
      );
    }
    
    // Extract branch ref (remove 'refs/heads/' prefix)
    const branchRef = branchCreated[2].ref.replace('refs/heads/', '');
    
    repoMetadata.branch = {
      name: branchRef,
      sha: branchCreated[2].object.sha
    };

    // Read objects
    for (const container in repoMetadata.containers) {
      const readResponse = await readObjectsFn(container);
      if (!readResponse[0]) {
        return ResponseFactory.error(
          `Unable to read the source objects [${container}/${objectFiles[container]}].`,
          readResponse,
          503
        );
      }
      
      repoMetadata.containers[container].objectSha = readResponse[2].sha;
      repoMetadata.containers[container].objects = readResponse[2].mrJson;
    }

    return ResponseFactory.success(
      `${Object.keys(repoMetadata.containers).length} containers are ready for use.`,
      repoMetadata,
      200
    );
  }

  /**
   * Releases containers (unlocks them and merges changes)
   * @param {Object} repoMetadata - Container metadata object
   * @param {Function} mergeBranchFn - Function to merge branch to main
   * @returns {Promise&lt;Array>} ResponseFactory result
   */
  async releaseContainers(repoMetadata, mergeBranchFn) {
    // Merge branch to main
    const mergeResponse = await mergeBranchFn(
      repoMetadata.branch.name, 
      repoMetadata.branch.sha
    );
    
    if (!mergeResponse[0]) {
      return ResponseFactory.error(
        'Unable to merge the branch to main.',
        mergeResponse,
        503
      );
    }

    // Unlock containers
    for (const container in repoMetadata.containers) {
      // Unlock branch
      const branchUnlocked = await this.unlockContainer(
        container, 
        repoMetadata.containers[container].lockSha,
        repoMetadata.branch.name
      );
      if (!branchUnlocked[0]) {
        return ResponseFactory.error(
          `Unable to unlock the container, objects may have been written please check [${container}] for objects and the lock file.`,
          branchUnlocked,
          503
        );
      }
      
      // Unlock main
      const mainUnlocked = await this.unlockContainer(
        container, 
        repoMetadata.containers[container].lockSha,
        this.mainBranchName
      );
      if (!mainUnlocked[0]) {
        return ResponseFactory.error(
          `Unable to unlock the container, objects may have been written please check [${container}] for objects and the lock file.`,
          mainUnlocked,
          503
        );
      }
    }

    // Return success
    return ResponseFactory.success(
      `Released [${Object.keys(repoMetadata.containers).length}] containers.`,
      null,
      200
    );
  }
}

export default ContainerOperations;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
